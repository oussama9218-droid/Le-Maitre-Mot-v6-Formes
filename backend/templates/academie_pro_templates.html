<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>{{ document.type_doc|title }} — {{ document.matiere }} {{ document.niveau }}</title>
  <style>
    @page {
      size: A4;
      margin: 2cm 1.5cm 2cm 1.5cm;
      @bottom-center {
        content: "Page " counter(page) " / " counter(pages);
        font-size: 9pt;
        color: #666;
      }
    }

    :root {
      --primary: {{ (template_colors.primary if template_colors and template_colors.primary) or '#2c3e50' }};
      --secondary: {{ (template_colors.secondary if template_colors and template_colors.secondary) or '#7f8c8d' }};
      --accent: {{ (template_colors.accent if template_colors and template_colors.accent) or '#3498db' }};
      --content-font: {{ (template_fonts.content if template_fonts and template_fonts.content) or 'Arial' }};
      --header-font: {{ (template_fonts.header if template_fonts and template_fonts.header) or 'Times New Roman' }};
    }

    body { font-family: var(--content-font), Arial, sans-serif; font-size: 11pt; line-height: 1.45; color: #333; }

    .header { display:grid; grid-template-columns:1fr 2fr 1fr; gap:10px; align-items:center; padding-bottom:12px; margin-bottom:16px; border-bottom:3px solid var(--primary); }
    .logo img { max-height:60px; max-width:120px; }
    .logo .placeholder { width:60px; height:60px; background:var(--secondary); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; border-radius:8px; font-size:9pt; }
    .titles { text-align:center; }
    .titles .title { font-family:var(--header-font); font-size:18pt; font-weight:800; color:var(--primary); margin:0; }
    .titles .subtitle { font-size:12pt; color:var(--secondary); margin:2px 0; }
    .titles .info { font-size:9pt; color:#666; }
    .school { text-align:right; font-size:10pt; color:var(--secondary); }
    .school .school-name { font-weight:700; color:var(--primary); }

    .student-line { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; padding:8px 12px; margin:8px 0 18px 0; border:1px solid #e5e7eb; background:#f9fafb; border-left:4px solid var(--accent); border-radius:6px; font-size:10pt; }
    .field { display:flex; gap:6px; align-items:center; }
    .field label { color:#555; min-width:65px; }
    .field .line { flex:1; border-bottom:1px dotted #999; height:18px; }

    .exercise { margin:0 0 22px 0; page-break-inside:avoid; }
    .exercise-header { display:flex; align-items:center; justify-content:space-between; padding:6px 10px; background:#f7f9fb; border-left:4px solid var(--primary); border-radius:4px; font-weight:700; }
    .points { font-size:10pt; color:#6b7280; font-style:italic; }
    .exercise-content { margin:10px 0 0 10px; }
    .exercise-text { text-align:justify; margin:6px 0 10px 0; }

    .answer-space { border:1px solid #e5e7eb; background:#fafafa; border-radius:4px; padding:6px; }
    .answer-lines { height:2.8cm; background-image:repeating-linear-gradient(transparent, transparent 0.6cm, #ddd 0.6cm, #ddd 0.62cm); }

    .solution { background:#f8f9fa; padding:10px 12px; border-radius:6px; border-left:4px solid #28a745; margin-top:6px; }
    .solution-title { font-weight:700; color:#28a745; margin-bottom:8px; }
    .step { margin-bottom:6px; padding-left:8px; }
    .final-result { background:#d4edda; padding:6px 8px; margin-top:8px; border-radius:6px; font-weight:700; }

    .bareme { margin-top:12px; padding:10px 12px; background:#e3f2fd; border-radius:6px; }
    .bareme-title { font-weight:700; color:var(--accent); margin-bottom:6px; }
    .bareme-item { font-size:10pt; margin-bottom:2px; }

    .sep { height:1px; background:linear-gradient(to right, transparent, var(--secondary), transparent); opacity:.35; margin:18px 0; }

    .footer { position:fixed; bottom:0; left:0; right:0; height:50px; display:flex; align-items:center; justify-content:space-between; font-size:9pt; color:var(--secondary); border-top:1px solid var(--accent); padding:0 1.5cm; }
    .footer-left { flex:1; }
    .footer-center { flex:1; text-align:center; }
    .footer-right { flex:1; text-align:right; font-weight:700; color:var(--primary); }
        /* NEW: Style for geometric schemas */
        .geometric-schema {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #333;
            background-color: #fafafa;
            border-radius: 8px;
        }
        
        .geometric-schema svg {
            max-width: 100%;
            height: auto;
        }

  </style>
</head>
<body>
  <div class="header">
    <div class="logo">
      {% if template_config and template_config.logo_url %}
        <img src="{{ template_config.logo_url }}" alt="Logo" />
      {% else %}
        <div class="placeholder">LOGO</div>
      {% endif %}
    </div>
    <div class="titles">
      {% if document.type_doc == 'controle' %}
        <div class="title">Contrôle</div>
      {% elif document.type_doc == 'dm' %}
        <div class="title">Devoir Maison</div>
      {% else %}
        <div class="title">Exercices</div>
      {% endif %}
      <div class="subtitle">{{ document.matiere }} — {{ document.niveau }}</div>
      <div class="subtitle">{{ document.chapitre }}</div>
      <div class="info">{{ date_creation }}</div>
    </div>
    <div class="school">
      {% if template_config and template_config.school_name %}<div class="school-name">{{ template_config.school_name }}</div>{% endif %}
      {% if template_config and template_config.professor_name %}<div>{{ template_config.professor_name }}</div>{% endif %}
      {% if template_config and template_config.school_year %}<div>{{ template_config.school_year }}</div>{% endif %}
    </div>
  </div>

  <!-- Ligne élève adaptée au type de document -->
  <div class="student-line">
    <div class="field"><label>Nom :</label><div class="line"></div></div>
    <div class="field"><label>Prénom :</label><div class="line"></div></div>
    <div class="field"><label>Classe :</label><div class="line"></div></div>
    {% if document.type_doc == 'controle' %}
      <div class="field"><label>Note :</label><div class="line"></div></div>
    {% elif document.type_doc == 'dm' %}
      <div class="field"><label>Date rendu :</label><div class="line"></div></div>
    {% else %}
      <div class="field"><label>Date :</label><div class="line"></div></div>
    {% endif %}
  </div>

  {% for exercise in document.exercises %}
  <div class="exercise">
    <div class="exercise-header">
      <div>Exercice {{ loop.index }}</div>
      <div class="points">{% set total_points = exercise.bareme|sum(attribute='points') %} ({{ "%.1f"|format(total_points) }} pts)</div>
    </div>
    <div class="exercise-content">
      <div class="exercise-text">{{ exercise.enonce }}
    
    <!-- NEW: Render geometric schema SVG if generated -->
    {% if exercise.schema_svg %}
        <div class="geometric-schema">
            {{ exercise.schema_svg|safe }}
        </div>
    {% endif %}
    
    
    <!-- NEW: Render geometric schema SVG if generated -->
    {% if exercise.schema_svg %}
        <div class="geometric-schema">
            {{ exercise.schema_svg|safe }}
        </div>
    {% endif %}
    </div>
      {% if exercise.type == 'qcm' and exercise.donnees and exercise.donnees.options %}
        <ul>
          {% for option in exercise.donnees.options %}<li>{{ option }}</li>{% endfor %}
        </ul>
      {% endif %}
      {% if document.type_doc in ['controle','dm'] %}
        <div class="answer-space"><div class="answer-lines"></div></div>
      {% endif %}
      {% if request.export_type == 'corrige' %}
        <div class="solution">
          <div class="solution-title">Solution :</div>
          {% if exercise.solution and exercise.solution.etapes %}
            {% for etape in exercise.solution.etapes %}
              <div class="step">{{ loop.index }}. {{ etape }}</div>
            {% endfor %}
          {% endif %}
          {% if exercise.solution and exercise.solution.resultat %}
            <div class="final-result">Résultat final : {{ exercise.solution.resultat }}</div>
          {% endif %}
        </div>
        {% if exercise.bareme %}
          <div class="bareme">
            <div class="bareme-title">Barème :</div>
            {% for item in exercise.bareme %}<div class="bareme-item">• {{ item.etape }} : {{ item.points }} pt(s)</div>{% endfor %}
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
  {% if not loop.last %}<div class="sep"></div>{% endif %}
  {% endfor %}

  <div class="footer">
    <div class="footer-left">{% if template_config and template_config.footer_text %}{{ template_config.footer_text }}{% endif %}</div>
    <div class="footer-center">{% if template_config and template_config.school_year %}{{ template_config.school_year }}{% endif %}</div>
    <div class="footer-right">Le Maître Mot Pro</div>
  </div>
</body>
</html>